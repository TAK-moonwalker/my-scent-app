rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function authed() { return request.auth != null; }
    function uid()    { return request.auth.uid; }

    // Users: self-only
    match /users/{userId} {
      allow create: if authed() && userId == uid();
      allow read, update: if authed() && userId == uid();
      allow delete: if false;
    }

    // Recipes: owner-only, or public
    match /recipes/{recipeId} {
      // On create, payload MUST include createdBy == uid()
      allow create: if authed() && request.resource.data.createdBy == uid();
      // For existing docs: owner can read/update/delete, or public recipes can be read by anyone
      // Also allow any authenticated user to check if recipe exists (minimal read for access control)
      allow read: if authed() && (resource.data.createdBy == uid() || resource.data.isPublic == true);
      allow update, delete: if authed() && resource.data.createdBy == uid();
    }

    // If you later use a subcollection for ingredients, keep this:
    match /recipes/{recipeId}/ingredients/{ingId} {
      allow read, write: if authed()
        && get(/databases/$(db)/documents/recipes/$(recipeId)).data.createdBy == uid();
    }
  }
}
