rules_version = '2';
service cloud.firestore {
  match /databases/{db}/documents {

    function authed() { return request.auth != null; }
    function uid()    { return request.auth.uid; }

    // Users: self-only
    match /users/{userId} {
      allow create: if authed() && userId == uid();
      allow read, update: if authed() && userId == uid();
      allow delete: if false;
    }

    // Recipes: owner-only
    match /recipes/{recipeId} {
      // On create, payload MUST include createdBy == uid()
      allow create: if authed() && request.resource.data.createdBy == uid();
      // For existing docs, owner is read from the stored doc
      allow read, update, delete: if authed() && resource.data.createdBy == uid();
    }

    // If you later use a subcollection for ingredients, keep this:
    match /recipes/{recipeId}/ingredients/{ingId} {
      allow read, write: if authed()
        && get(/databases/$(db)/documents/recipes/$(recipeId)).data.createdBy == uid();
    }
  }
}
